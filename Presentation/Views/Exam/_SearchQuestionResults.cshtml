@model List<Domain.Entities.BankQuestion>
@{
    var selectedIds = ViewData["SelectedIds"] as List<int> ?? new List<int>();
}
@{
    var totalPages = ViewBag.TotalPages as int? ?? 1;
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
}

<!-- _SearchQuestionResults.cshtml -->

<style>
    /* Đặt box-sizing để tính padding vào width */
    #questionTable th, #questionTable td {
        box-sizing: border-box;
    }

    /* Cột Chi tiết */
    #questionTable thead tr th:nth-child(5),
    #questionTable tbody tr td:nth-child(5) {
        width: 70px;
        text-align: center;
    }

    #questionTable {
        border-collapse: collapse;
        width: 100%; /* đổi từ 120% thành 100% */
        max-width: 100%; /* tránh table vượt container */
        table-layout: fixed;
        /* Không đặt overflow hay max-height ở đây */
    }

        #questionTable thead tr th {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-bottom: 2px solid #ccc;
            height: 40px;
            line-height: 40px;
            text-align: left;
            padding: 5px;
            font-weight: bold;
        }

        #questionTable tbody {
            display: table-row-group;
            max-height: none;
            overflow-y: visible;
            overflow-x: hidden;
            width: 100%;
        }


            /* Giữ layout chuẩn */
            #questionTable thead,
            #questionTable tbody tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

                /* Cột checkbox */
                #questionTable thead tr th:nth-child(1),
                #questionTable tbody tr td:nth-child(1) {
                    width: 80px;
                    text-align: center;
                }

                    #questionTable tbody tr td:nth-child(1) input[type="checkbox"] {
                        width: 24px;
                        height: 24px;
                        cursor: pointer;
                    }

                /* Cột Nội dung rộng nhất */
                #questionTable thead tr th:nth-child(2),
                #questionTable tbody tr td:nth-child(2) {
                    width: 60%;
                    padding-left: 10px;
                    white-space: normal;
                }

                /* Cột Loại câu hỏi */
                #questionTable thead tr th:nth-child(3),
                #questionTable tbody tr td:nth-child(3) {
                    width: 18%;
                    padding-left: 5px;
                    white-space: nowrap;
                    font-size: 0.9em;
                    color: #555;
                }

                /* Cột Độ khó */
                #questionTable thead tr th:nth-child(4),
                #questionTable tbody tr td:nth-child(4) {
                    width: 15%;
                    padding-left: 5px;
                    white-space: nowrap;
                    font-size: 0.9em;
                    color: #555;
                }

</style>

<table id="questionTable" >
    <thead>
        <tr>
            <th>Chọn</th>
            <th>Nội dung</th>
            <th>Loại câu hỏi</th>
            <th>Độ khó</th>
            <th>Chi tiết</th>
        </tr>

    </thead>

    <tbody>
        @foreach (var q in Model)
        {
            <tr class="question-row" data-id="@q.Id">

                <td>
                    <input type="checkbox" class="question-checkbox" value="@q.Id" @(selectedIds.Contains(q.Id) ? "checked" : "") />
                </td>
                <td>@q.Content</td>
                <td>@q.QuestionType?.Name</td>
                <td>@q.Level?.DisplayName</td>
                <td>
                    <div class="d-flex gap-1">
                        <button type="button" class="btn btn-info btn-sm btn-view-detail" data-id="@q.Id" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>

                        <a href="/Exam/EditExamQuestion/@q.Id" class="btn btn-sm btn-primary" title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                </td>


            </tr>
        }
    </tbody>

	
</table>



<div class="modal fade" id="questionDetailModal" tabindex="-1" aria-labelledby="questionDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="questionDetailModalLabel">Chi tiết câu hỏi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <h6 id="questionContent"></h6>
                <ul id="answerList" class="list-group mt-3"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>


<div class="mt-4 d-flex justify-content-center">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            @for (int i = 1; i <= (int)ViewData["TotalPages"]; i++)
            {
                var current = (int)ViewData["CurrentPage"];
                <li class="page-item @(i == current ? "active" : "")">
                    <a href="#" class="page-link pagination-link" data-page="@i">@i</a>
                </li>
            }
        </ul>
    </nav>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Nếu chưa có Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>





<script>
       

    $(function(){
        $('.btn-view-detail').click(function(){
            var questionId = $(this).data('id');

            $.ajax({
                url: '@Url.Action("GetQuestionDetail", "Exam")', // Controller + Action đúng của bạn
                data: { id: questionId },
                type: 'GET',
                  success: function(detail){
        console.log(detail);
        if(detail && detail.answers && Array.isArray(detail.answers)) {
            $('#questionContent').text(detail.content);  // sửa thành content
            var answersHtml = '';
            detail.answers.forEach(function(a){
                var correctMark = a.isCorrected ? '✔️' : '';  // lưu ý isCorrected hay iscorrected, đúng tên trường
                answersHtml += '<li class="list-group-item">' + a.answerText + ' ' + correctMark + '</li>';
            });
            $('#answerList').html(answersHtml);
            var modal = new bootstrap.Modal(document.getElementById('questionDetailModal'));
            modal.show();
        } else {
            alert('Không tìm thấy chi tiết câu hỏi hoặc câu trả lời!');
        }
    },

                error: function(){
                    alert('Lỗi khi lấy chi tiết câu hỏi!');
                }
            });
        });
    });
</script>


<script>
       
        function loadPage(page) {
        currentPage = page;

        const questionTypeId = $('#QuestionTypeId').val();
        const levelId = $('#LevelId').val();
        const isPublic = $('#IsPublic').val();
        const keyword = $('#Keyword').val();

        $.ajax({
            url: '@Url.Action("SearchQuestions", "Exam")',
            data: {
                questionTypeId,
                levelId,
                isPublic,
                keyword,
                page
            },
            success: function (data) {
                $('#questionListContainer').html(data);
                markSelectedCheckboxes(); // ✅ Đảm bảo chạy lại
            },
            error: function () {
                alert("Không thể tải dữ liệu.");
            }
        });
    }

              function markSelectedCheckboxes() {
        $('.question-checkbox').each(function () {
            const id = parseInt($(this).val());
            $(this).prop('checked', selectedQuestionIds.includes(id));
        });
    }


        function reloadQuestionTable() {
        loadQuestions(currentPage); // hoặc truyền page hiện tại đang đứng
    }

        
    

</script>

<script>
             function chonCauHoiNgauNhien() {
        const max = parseInt($('#randomCount').val());
        if (isNaN(max) || max <= 0) {
            alert("Vui lòng chọn số lượng hợp lệ.");
            return;
        }

        const questionTypeId = $('#QuestionTypeId').val();
        const levelId = $('#LevelId').val();
        const isPublic = $('#IsPublic').val();
        const keyword = $('#Keyword').val();

        $.ajax({
            url: '/Exam/GetRandomQuestionIds',
            type: 'GET',
            data: {
                count: max,
                questionTypeId,
                levelId,
                isPublic,
                keyword
            },
            success: function (ids) {
                selectedQuestionIds = ids;
                markSelectedCheckboxes();
                $('#questionCountWarning').hide();
            },
            error: function () {
                alert("Lỗi khi chọn ngẫu nhiên câu hỏi.");
            }
        });
    }


       $(document).on('change', '.question-checkbox', function () {
        const id = parseInt($(this).val());
        if ($(this).is(':checked')) {
            if (!selectedQuestionIds.includes(id)) {
                selectedQuestionIds.push(id);
            }
        } else {
            selectedQuestionIds = selectedQuestionIds.filter(x => x !== id);
        }
    });






</script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
