@*
    Trang danh sách đề thi - Giao diện cải tiến
*@

@using Microsoft.AspNetCore.Identity
@using System.Security.Claims

@{
    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

@model Application.DTOs.ViewModel.ExamSubjectViewModel;


<style>
    #btn-dechung.active,
    #btn-detutao.active {
        background-color: #007bff; /* Màu xanh dương */
        color: white;
        font-weight: bold;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
        transition: 0.3s ease;
    }

    #btn-dechung:hover,
    #btn-detutao:hover {
        background-color: #f0f0f0;
    }
</style>


<div class="container py-4" style="min-height: 65vh">
    <h1 class="text-center mb-4 text-primary fw-bold">📘 Danh sách các đề thi</h1>

    <div class="table-responsive">
        <table class="table table-hover align-middle shadow-sm">
            <thead class="table-dark text-center">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">📝 Tiêu đề</th>
                    <th scope="col">📖 Miêu tả</th>
                    <th scope="col">📄 Văn bản nguồn</th>
                    <th scope="col">❓ Tổng câu hỏi</th>
                    <th scope="col">📅 Ngày tạo</th>
                    <th scope="col">🎯 Hoạt động</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int stt = 1;
                }
                @foreach (var exam in Model)
                {
                    <tr>
                        <td class="text-center fw-semibold">@stt</td>
                        <td>@exam.Title</td>
                        <td>@exam.Description</td>
                        <td><span class="badge bg-info text-dark">@exam.SourceText</span></td>
                        <td><span class="badge bg-secondary">@exam.TotalQuestion câu</span></td>
                        <td><span class="text-muted">@exam.CreatedAt.ToString("dd/MM/yyyy")</span></td>
                        <td>
                            <form id="exam-form-@exam.Id" method="post" asp-controller="Exam" asp-action="GetExamTakeById">
                                <input type="hidden" name="examId" value="@exam.Id" />
                                <button class="btn btn-primary exam-start-btn w-100 mb-2" type="submit" data-exam-id="@exam.Id">
                                    🚀 Vào thi
                                </button>
                            </form>
                            <a asp-controller="ExamScored" asp-action="AllExamScoredByUserIdByExamId" asp-route-userId="@userId" asp-route-examId="@exam.Id"
                               class="btn btn-outline-danger w-100">
                                📊 Xem kết quả
                            </a>
                        </td>
                    </tr>
                    stt++;
                }
            </tbody>
        </table>
    
    <div class="d-flex justify-content-center align-items-center mb-1">
        <div class="me-3 border border-1 border-dark rounded rounded-3 px-3 py-2" id="btn-dechung" style="cursor: pointer">
            <h3>Đề chung</h3>
        </div>
        <div class="ms-3 border border-1 border-dark rounded rounded-3 px-3 py-2" id="btn-detutao" style="cursor: pointer">
            <h3 >Đề tự tạo</h3>
        </div>
    </div>

    <div class="btn mb-3" style="left:20px">
        <select id="subject-select" class="form-select w-auto d-inline-block ms-2">
            <option value="">Tất cả</option>
            @foreach(var subject in Model.Subjects)
            {
                <option value="@subject.Id">@subject.Name</option>
            }
        </select>
    </div>
    
        <div id="exam-list">
            @await Html.PartialAsync("_ExamListPartial", Model)
        </div>
    
</div>

@section Scripts {
    <script>
        const userId = "@userId";

        document.getElementById("btn-dechung").addEventListener("click", function () {
            this.classList.add("active");
            document.getElementById("btn-detutao").classList.remove("active");
            loadExamList(true);
        });

        document.getElementById("btn-detutao").addEventListener("click", function () {
            this.classList.add("active");
            document.getElementById("btn-dechung").classList.remove("active");
            loadExamList(false);
        });

        document.getElementById("subject-select").addEventListener("change", function () {
            const isPublic = document.getElementById("btn-dechung").classList.contains("active");
            loadExamList(isPublic);
        });

        function loadExamList(isPublic) {
            const selectedSubjectId = document.getElementById("subject-select").value;
            fetch(`/Exam/AllExams?isPublic=${isPublic}&subjectId=${selectedSubjectId}`, {
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
                .then(res => res.text())
                .then(html => {
                    document.getElementById("exam-list").innerHTML = html;
                    updateExamButtons(); // Re-init button states after reload
                });
        }

        function updateExamButtons() {
            let localData = JSON.parse(localStorage.getItem("examStates") || "{}");
            const currentExamIds = Object.keys(localData[userId] || {});
            const ongoingExamId = currentExamIds.length > 0 ? currentExamIds[0] : null;

            document.querySelectorAll(".exam-start-btn").forEach(btn => {
                const examId = btn.getAttribute("data-exam-id");

                if (examId === ongoingExamId) {
                    btn.innerText = "⏱️ Tiếp tục làm bài";
                    btn.classList.remove("btn-primary");
                    btn.classList.add("btn-warning");
                } else if (ongoingExamId !== null) {
                    btn.disabled = true;
                    btn.title = "⚠️ Bạn đang làm một bài thi khác. Vui lòng hoàn thành trước khi làm bài mới.";
                    btn.classList.add("opacity-50", "cursor-not-allowed");
                }
            });
        }

        updateExamButtons();
    </script>
}
