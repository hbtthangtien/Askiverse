@using Application.DTOs.Question.GenerateAI
@model RequestGenerateAI
@{
    ViewData["Title"] = "Tạo câu hỏi AI từ tài liệu";
    var titleColor = "#D13D76";
}
<div class="container py-5" style="min-height:70vh;">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg border-0" style="border-radius: 2rem; background:rgba(255,255,255,0.92)">
                <div class="card-body p-5">
                    <h2 class="mb-4 fw-bold text-center" style="color:@titleColor">
                        Tạo câu hỏi AI từ tài liệu
                    </h2>
                    @using (Html.BeginForm("Index", "GenerateExam", FormMethod.Post, new { enctype = "multipart/form-data" }))
                    {
                        <div class="mb-3">
                            <label class="form-label fw-semibold" style="color:@titleColor">1. Chọn file tài liệu (.pdf, .docx, .png, .jpg)</label>
                            <input asp-for="File" type="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"
                                   class="form-control rounded-3 border-2"
                                   style="border-color:#FE9FC3; background:#FAD3E7;" />
                            @Html.ValidationMessageFor(m => m.File, "", new { @class = "text-danger small" })
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold" style="color:@titleColor">2. Loại câu hỏi</label>
                            <select asp-for="QuestionTypeId" class="form-select rounded-3 border-2" style="border-color:#C4F0E0; background:#F0F8F6;">
                                <option value="">-- Chọn loại câu hỏi --</option>
                                <option value="1">Multiple Choice</option>
                                <option value="2">Fill in the Blank</option>
                                <option value="3">Matching</option>
                            </select>
                            @Html.ValidationMessageFor(m => m.QuestionTypeId, "", new { @class = "text-danger small" })
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold" style="color:@titleColor">3. Số lượng câu hỏi</label>
                            <div class="d-flex gap-3 mb-2">
                                <button type="button" class="btn btn-sm fw-bold px-4 py-2 rounded-pill border-2 total-btn"
                                        style="background:#D13D76;color:#fff;border-color:#D8F8F2;"
                                        data-value="10">
                                    10
                                </button>
                                <button type="button" class="btn btn-sm fw-bold px-4 py-2 rounded-pill border-2 total-btn"
                                        style="background:#fff;color:#000;border-color:#D8F8F2;"
                                        data-value="25">
                                    25
                                </button>
                               @*  <button type="button" class="btn btn-sm fw-bold px-4 py-2 rounded-pill border-2 total-btn"
                                        style="background:#fff;color:#000;border-color:#D8F8F2;"
                                        data-value="50">
                                    50
                                </button> *@
                                <input type="hidden" name="TotalQuestions" id="TotalQuestions" value="10" />
                            </div>
                            <div class="form-text" style="color:#121117">Tổng số câu hỏi phải chia đủ vào 3 mức dưới.</div>
                        </div>
                        <div class="row g-2 mb-1">
                            <div class="col-4">
                                <label class="fw-semibold" style="color:@titleColor">Dễ</label>
                                <input id="EasyInput" name="NumberEasyQuestion" type="number" min="0" value="0"
                                       class="form-control rounded-3 border-2 text-center auto-calc" style="border-color:#C4F0E0" />
                            </div>
                            <div class="col-4">
                                <label class="fw-semibold" style="color:@titleColor">Trung bình</label>
                                <input id="MediumInput" name="NumberMediumQuestion" type="number" min="0" value="0"
                                       class="form-control rounded-3 border-2 text-center auto-calc" style="border-color:#C4F0E0" />
                            </div>
                            <div class="col-4">
                                <label class="fw-semibold" style="color:@titleColor">Khó</label>
                                <input id="HardInput" name="NumberHardQuestion" type="number" min="0" value="0"
                                       class="form-control rounded-3 border-2 text-center auto-calc" style="border-color:#C4F0E0" />
                            </div>
                        </div>
                        <div class="form-text small mb-3" style="color:#121117">
                            Tổng: <span id="CurrentTotal" class="fw-bold">0</span> /
                            <span id="MaxTotal">10</span>
                        </div>
                        <div id="ErrorMsg" class="alert alert-danger rounded-3 text-center py-2" style="display:none;"></div>
                        @if (ViewBag.Error != null)
                        {
                            <div class="alert alert-danger rounded-3 text-center py-2">@ViewBag.Error</div>
                        }
                        @if (ViewBag.Success != null)
                        {
                            <div class="alert alert-success rounded-3 text-center py-2">@ViewBag.Success</div>
                        }
                        <div id="loading-overlay" style="display:none; position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);align-items:center;justify-content:center;">
                            <div class="spinner-border text-pink" role="status" style="width:3rem;height:3rem;color:#D13D76;">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <div class="fw-bold mt-3" style="color:#D13D76;font-size:1.2rem;">Đang tạo câu hỏi, vui lòng chờ...</div>
                        </div>

                        <button type="submit" class="btn w-100 fw-bold text-white mt-3"
                                style="background:#D13D76; border-radius:2rem; font-size:1.1rem;">
                            Tạo câu hỏi AI
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        document.querySelector("form").addEventListener("submit", function (e) {
            // Kiểm tra validate phía client, nếu cần
            var error = document.getElementById('ErrorMsg');
            if (error && error.style.display === 'block') {
                e.preventDefault(); // Không submit nếu lỗi tổng số câu
                return false;
            }
            document.getElementById("loading-overlay").style.display = "flex";
        });
        // Chọn số lượng client-side (không reload)
        document.querySelectorAll('.total-btn').forEach(btn => {
            btn.onclick = function () {
                // Đổi màu active
                document.querySelectorAll('.total-btn').forEach(b => {
                    b.style.background = "#fff";
                    b.style.color = "#000";
                });
                btn.style.background = "#D13D76";
                btn.style.color = "#fff";

                // Set lại tổng
                let total = btn.dataset.value;
                document.getElementById('TotalQuestions').value = total;
                document.getElementById('MaxTotal').innerText = total;
                // Reset các input
                document.getElementById('EasyInput').value = 0;
                document.getElementById('MediumInput').value = 0;
                document.getElementById('HardInput').value = 0;
                document.getElementById('CurrentTotal').innerText = 0;
                document.getElementById('ErrorMsg').style.display = 'none';
            };
        });

        // Auto-calc: nhập 2 ô tự động tính ô còn lại
        function autoCalc(e) {
            let total = parseInt(document.getElementById('TotalQuestions').value) || 0;
            let easy = parseInt(document.getElementById('EasyInput').value) || 0;
            let medium = parseInt(document.getElementById('MediumInput').value) || 0;
            let hard = parseInt(document.getElementById('HardInput').value) || 0;

            let fields = [
                { el: document.getElementById('EasyInput'), val: easy },
                { el: document.getElementById('MediumInput'), val: medium },
                { el: document.getElementById('HardInput'), val: hard }
            ];

            // Đếm số ô có giá trị (có nhập, khác 0)
            
            easy = parseInt(document.getElementById('EasyInput').value) || 0;
            medium = parseInt(document.getElementById('MediumInput').value) || 0;
            hard = parseInt(document.getElementById('HardInput').value) || 0;
            let sum = easy + medium + hard;
            document.getElementById('CurrentTotal').innerText = sum;

            // Validate
            if (sum > total) {
                document.getElementById('ErrorMsg').innerText = "Tổng số câu vượt quá tổng đã chọn!";
                document.getElementById('ErrorMsg').style.display = 'block';
            } else if (sum < total && filled === 3) {
                document.getElementById('ErrorMsg').innerText = "Tổng số câu chưa đủ!";
                document.getElementById('ErrorMsg').style.display = 'block';
            } else {
                document.getElementById('ErrorMsg').style.display = 'none';
            }
        }
        document.getElementById('EasyInput').addEventListener('input', autoCalc);
        document.getElementById('MediumInput').addEventListener('input', autoCalc);
        document.getElementById('HardInput').addEventListener('input', autoCalc);

        // Load lại tổng khi render
        document.addEventListener('DOMContentLoaded', autoCalc);
    </script>
    <partial name="_ValidationScriptsPartial" />
}
